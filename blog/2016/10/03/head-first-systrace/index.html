<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <title>
       Head First Systrace &middot;  Hujiawei Bujidao
    </title>

    <meta name="generator" content="Hugo 0.67.0" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta property="og:title" content=" Head First Systrace &middot;  Hujiawei Bujidao" />
  	<meta property="og:site_name" content="Hujiawei Bujidao" />
  	<meta property="og:url" content="https://hujiaweibujidao.github.io/blog/2016/10/03/head-first-systrace/" />

    
  	<meta property="og:type" content="article" />
    <meta property="og:article:published_time" content="2016-10-03T00:00:00Z" />
    
    <meta property="og:article:tag" content="android" />
    
    

    <meta name="description" content="Happy Coding &amp; Enjoy Living" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://hujiaweibujidao.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://hujiaweibujidao.github.io/images/apple-touch-icon.png" />
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/hugo.css" />

    
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/highlight.css">
    
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/github-gist.css">
    
    <script src="https://hujiaweibujidao.github.io/js/highlight.js"></script>
    <script type="text/javascript">hljs.initHighlightingOnLoad();</script>

    
    

    

    <link rel="canonical" href="https://hujiaweibujidao.github.io/blog/2016/10/03/head-first-systrace/" />

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        

        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://hujiaweibujidao.github.io/">Home</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://hujiaweibujidao.github.io/about">About</a>
            </li>
        

        <li class="nav-opened" role="presentation"><a href=""></a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/algorithm/">tags/algorithm</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/android/">tags/android</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/swift/">tags/swift</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/reactnative/">tags/reactnative</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/python/">tags/python</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/java/">tags/java</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/dev/">tags/dev</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/life/">tags/life</a></li>
    </ul>

    
    

    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




  <header class="main-header post-head" style="background-image: url(https://www.bing.com/ImageResolution.aspx?w=1366&amp;h=768)">
  

    <nav class="main-nav overlay clearfix">
    
        
    
    
        <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
    
</nav>

    <div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">Head First Systrace</h1>
            <h2 class="page-description">Hujiawei Bujidao</h2> <br/>
            
    <a class="bloglogo" href="https://github.com/hujiaweibujidao" target="_blank">
    <span class="icon-github" style="color:white;font-size:2em"></span>
    </a>
&nbsp;


    <a class="bloglogo" href="https://weibo.com/hujiaweiyinger" target="_blank">
        <span class="icon-twitter" style="color:white;font-size:2em"></span>
    </a>
&nbsp;




    <a class="bloglogo" href="https://www.linkedin.com/in/hujiaweibujidao" target="_blank">
        <span class="icon-linkedin" style="color:white;font-size:2em"></span>
    </a>
&nbsp;


        </div>
    </div>
</header>



<main class="content" role="main">
  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Head First Systrace</h1>
        

        <section class="post-meta">
        
          <span class="post-tag small"><a href="https://hujiaweibujidao.github.io/tags/android/">#android</a></span>
        
        &nbsp;&nbsp;
        
          <time class="post-date" datetime="2016-10-03T00:00:00Z">
            2016/10/3
          </time>
        
        </section>
        <br/>
    </header>

    <section class="post-content">
      <p>深入浅出systrace（1）systrace的简单介绍和systrace工具源码分析。</p>
<p><strong>1.systrace工具简单介绍</strong></p>
<p>英文介绍文档推荐阅读官方文档<a href="https://developer.android.com/studio/profile/systrace-commandline.html">systrace-commandline</a></p>
<p>The Systrace tool helps analyze the performance of your application by capturing and displaying execution times of your applications processes and other Android system processes. The tool combines data from the Android kernel such as the CPU scheduler, disk activity, and application threads to generate an HTML report that shows an overall picture of an Android device’s system processes for a given period of time.</p>
<p>中文介绍文档推荐看<a href="http://www.ithtw.com/1009.html">这篇文章</a>，从中我们可以知道</p>
<p>systrace是<code>Android4.1(API 16)</code>中新增的性能数据采样和分析工具，它可帮助开发者收集Android关键子系统（如surfaceflinger、WindowManagerService等Framework部分关键模块、服务，View系统等）的运行信息，从而帮助开发者更直观的分析系统瓶颈，改进性能。systrace的功能包括跟踪系统的I/O操作、内核工作队列、CPU负载以及Android各个子系统的运行状况等。在Android平台中，它主要由3部分组成：</p>
<p><strong>内核部分</strong>：systrace利用了Linux Kernel中的<code>ftrace</code>功能，所以，如果要使用systrace的话，必须开启kernel中和ftrace相关的模块。
<strong>数据采集部分</strong>：Android定义了一个Trace类，应用程序可利用该类把统计信息输出给ftrace。同时，Android还有一个<code>atrace</code>程序，它可以从ftrace中读取统计信息然后交给数据分析工具来处理。
<strong>数据分析工具</strong>：Android SDK中提供一个systrace.py脚本用来配置数据采集的方式（如采集数据的标签、输出文件名等）和收集ftrace统计数据并生成一个结果网页文件供用户查看。</p>
<p><strong>从本质上说，systrace是对Linux Kernel中ftrace的封装，应用进程需要利用Android提供的Trace类来使用systrace。</strong></p>
<p><strong>2.systrace数据抓取方式</strong></p>
<p>除了使用Android Studio和Eclipse中集成的systrace工具之外，我们还可以使用Android SDK中提供的systrace工具来抓取性能日志。systrace.py是个脚本文件，位于<code>{Android SDK}/platform-tools/systrace</code>文件夹中，它的作用是收集systrace数据并提供网页文件结果供用户查看。</p>
<p>需要注意的是，不同版本的Android系统对应的systrace命令的参数形式略有不同，下面是常用的调用形式</p>
<pre><code>python systrace.py [options] [category1] [category2] ... [categoryN]
</code></pre><p>下面是Android 4.3及以上版本的Android系统的systrace命令参数形式。
<img src="https://hujiaweibujidao.github.io/images/systrace_options_43.png" alt="img"></p>
<p>下面是Android 4.2及以下版本的Android系统的systrace命令参数形式。</p>
<p><img src="https://hujiaweibujidao.github.io/images/systrace_options_41.png" alt="img"></p>
<p>systrace工具实际上是调用atrace命令来获取数据结果，所以其实也可以执行atrace命令来抓取数据。</p>
<pre><code>➜  ~ adb shell atrace -h
atrace: invalid option -- h

usage: atrace [options] [categories...]
options include:
  -a appname      enable app-level tracing for a comma separated list of cmdlines
  -b N            use a trace buffer size of N KB
  -c              trace into a circular buffer
  -k fname,...    trace the listed kernel functions
  -n              ignore signals
  -s N            sleep for N seconds before tracing [default 0]
  -t N            trace for N seconds [defualt 5]
  -z              compress the trace dump
  --async_start   start circular trace and return immediatly
  --async_dump    dump the current contents of circular trace buffer
  --async_stop    stop tracing and dump the current contents of circular
                    trace buffer
  --list_categories
                  list the available tracing categories
</code></pre><p><strong>3.systrace工具源码分析</strong></p>
<p><strong>3.1 systrace工具的源码目录结构</strong></p>
<pre><code>➜  systrace tree
.
├── AUTHORS
├── LICENSE
├── NOTICE
├── UPSTREAM_REVISION
├── agents
│   ├── __init__.py
│   └── atrace_agent.py
├── prefix.html
├── suffix.html
├── systrace-legacy.py
├── systrace.py
├── systrace_agent.py
├── systrace_trace_viewer.html
├── trace.html
└── util.py

1 directory, 14 files
</code></pre><p>systrace工具中的主要类和类中的方法及其之间的关系如下图所示：</p>
<p><img src="https://hujiaweibujidao.github.io/images/systrace.png" alt="img"></p>
<p><strong>3.2 systrace.py文件</strong></p>
<p><strong>3.2.1 python版本问题</strong></p>
<p>从systrace.py的脚本内容来看，systrace工具只支持Python 2.7版本，不支持其他的python版本。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Make sure we&#39;re using a new enough version of Python.</span>
<span style="color:#75715e"># The flags= parameter of re.sub() is new in Python 2.7. And Systrace does not</span>
<span style="color:#75715e"># support Python 3 yet.</span>
version <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>version_info[:<span style="color:#ae81ff">2</span>]
<span style="color:#66d9ef">if</span> version <span style="color:#f92672">!=</span> (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">7</span>):
  sys<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;This script does not support Python </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">.</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">. &#39;</span>
                   <span style="color:#e6db74">&#39;Please use Python 2.7.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> version)
  sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
</code></pre></div><p><strong>3.2.2 systrace.py文件分析</strong></p>
<p>从main方法中可以看出抓取systrace的主流程是：
1.解析命令行中的参数，对应parse_options方法；
2.根据参数创建对应的agent，对应create_agents方法；
3.启动agent来抓取性能日志，对应agent的start方法；
4.收集agent抓取得到的性能日志，对应agent的collect_result方法；
5.将收集的数据写入到html文件中，对应write_trace_html方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
  options, categories <span style="color:#f92672">=</span> parse_options(sys<span style="color:#f92672">.</span>argv)
  agents <span style="color:#f92672">=</span> create_agents(options, categories)

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> agents:
    dirs <span style="color:#f92672">=</span> DEFAULT_AGENT_DIR
    <span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>agent_dirs:
      dirs <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;,&#39;</span> <span style="color:#f92672">+</span> options<span style="color:#f92672">.</span>agent_dirs
    sys<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;No systrace agent is available in directories |</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">|.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span>
                     dirs)
    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)

  <span style="color:#66d9ef">try</span>:
    update_systrace_trace_viewer <span style="color:#f92672">=</span> __import__(<span style="color:#e6db74">&#39;update_systrace_trace_viewer&#39;</span>)
  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
    <span style="color:#66d9ef">pass</span>
  <span style="color:#66d9ef">else</span>:
    update_systrace_trace_viewer<span style="color:#f92672">.</span>update()

  <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> agents:
    a<span style="color:#f92672">.</span>start()

  <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> agents:
    a<span style="color:#f92672">.</span>collect_result()
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> a<span style="color:#f92672">.</span>expect_trace():
      <span style="color:#75715e"># Nothing more to do.</span>
      <span style="color:#66d9ef">return</span>

  script_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">0</span>]))
  write_trace_html(options<span style="color:#f92672">.</span>output_file, script_dir, agents)
</code></pre></div><p>1.parse_options方法使用的是<code>optparse</code>模块来初始化命令参数和解析命令行。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_options</span>(argv):
  <span style="color:#e6db74">&#34;&#34;&#34;Parses and checks the command-line options.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  Returns:
</span><span style="color:#e6db74">    A tuple containing the options structure and a list of categories to
</span><span style="color:#e6db74">    be traced.
</span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
  usage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Usage: %prog [options] [category1 [category2 ...]]&#39;</span>
  desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Example: %prog -b 32768 -t 15 gfx input view sched freq&#39;</span>
  parser <span style="color:#f92672">=</span> optparse<span style="color:#f92672">.</span>OptionParser(usage<span style="color:#f92672">=</span>usage, description<span style="color:#f92672">=</span>desc)
  parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-o&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;output_file&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;write HTML to FILE&#39;</span>,
                    default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;trace.html&#39;</span>, metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;FILE&#39;</span>)
  parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-t&#39;</span>, <span style="color:#e6db74">&#39;--time&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;trace_time&#39;</span>, type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;int&#39;</span>,
                    help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;trace for N seconds&#39;</span>, metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;N&#39;</span>)
  parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-b&#39;</span>, <span style="color:#e6db74">&#39;--buf-size&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;trace_buf_size&#39;</span>, type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;int&#39;</span>,
                    help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;use a trace buffer size of N KB&#39;</span>, metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;N&#39;</span>)
  <span style="color:#f92672">......</span> more options <span style="color:#f92672">......</span>
  options, categories <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args(argv[<span style="color:#ae81ff">1</span>:])

  <span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>link_assets <span style="color:#f92672">or</span> options<span style="color:#f92672">.</span>asset_dir <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;trace-viewer&#39;</span>:
    parser<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#39;--link-assets and --asset-dir are deprecated.&#39;</span>)

  <span style="color:#66d9ef">if</span> (options<span style="color:#f92672">.</span>trace_time <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None) <span style="color:#f92672">and</span> (options<span style="color:#f92672">.</span>trace_time <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>):
    parser<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#39;the trace time must be a positive number&#39;</span>)

  <span style="color:#66d9ef">if</span> (options<span style="color:#f92672">.</span>trace_buf_size <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None) <span style="color:#f92672">and</span> (options<span style="color:#f92672">.</span>trace_buf_size <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>):
    parser<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#39;the trace buffer size must be a positive number&#39;</span>)

  <span style="color:#66d9ef">return</span> (options, categories)
</code></pre></div><p>2.create_agents方法根据解析的命令行参数创建并初始化agents，所谓的agent就是一个用来获取systrace数据的本地代理。使用者可以通过<code>--agent-dirs</code>来指定agent存放的目录，如果没有指定的话会默认加载并创建放在agents这个目录(package)下面的agents。其中的<code>try_create_agent</code>方法的实现在<code>atrace_agent.py</code>文件中，后面会介绍到。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_agents</span>(options, categories):
  <span style="color:#e6db74">&#34;&#34;&#34;Create systrace agents.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  This function will search systrace agent modules in agent directories and
</span><span style="color:#e6db74">  create the corresponding systrace agents.
</span><span style="color:#e6db74">  Args:
</span><span style="color:#e6db74">    options: The command-line options.
</span><span style="color:#e6db74">categories: &#34;The&#34;
</span><span style="color:#e6db74">  Returns:
</span><span style="color:#e6db74">    The list of systrace agents.
</span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
  agent_dirs <span style="color:#f92672">=</span> [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(__file__), DEFAULT_AGENT_DIR)]
  <span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>agent_dirs:
    agent_dirs<span style="color:#f92672">.</span>extend(options<span style="color:#f92672">.</span>agent_dirs<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>))

  agents <span style="color:#f92672">=</span> []
  <span style="color:#66d9ef">for</span> agent_dir <span style="color:#f92672">in</span> agent_dirs:
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> agent_dir:
      <span style="color:#66d9ef">continue</span>
    <span style="color:#66d9ef">for</span> filename <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(agent_dir):
      (module_name, ext) <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>splitext(filename)
      <span style="color:#66d9ef">if</span> (ext <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.py&#39;</span> <span style="color:#f92672">or</span> module_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__init__&#39;</span>
          <span style="color:#f92672">or</span> module_name<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;_unittest&#39;</span>)):
        <span style="color:#66d9ef">continue</span>
      (f, pathname, data) <span style="color:#f92672">=</span> imp<span style="color:#f92672">.</span>find_module(module_name, [agent_dir])
      <span style="color:#66d9ef">try</span>:
        module <span style="color:#f92672">=</span> imp<span style="color:#f92672">.</span>load_module(module_name, f, pathname, data)
      <span style="color:#66d9ef">finally</span>:
        <span style="color:#66d9ef">if</span> f:
          f<span style="color:#f92672">.</span>close()
      <span style="color:#66d9ef">if</span> module:
        agent <span style="color:#f92672">=</span> module<span style="color:#f92672">.</span>try_create_agent(options, categories)
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> agent:
          <span style="color:#66d9ef">continue</span>
        agents<span style="color:#f92672">.</span>append(agent)
  <span style="color:#66d9ef">return</span> agents
</code></pre></div><p>3.write_trace_html方法用来将agents收集的数据写入到html文件中，通常我们得到的网页结果文件的开头和结尾都是一样的，因为这个方法生成html文件的方式是先写入<code>prefix.html</code>文件，然后遍历agents得到的结果并写入，最后写入<code>suffix.html</code>文件。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_trace_html</span>(html_filename, script_dir, agents):
  <span style="color:#e6db74">&#34;&#34;&#34;Writes out a trace html file.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  Args:
</span><span style="color:#e6db74">    html_filename: The name of the file to write.
</span><span style="color:#e6db74">    script_dir: The directory containing this script.
</span><span style="color:#e6db74">    agents: The systrace agents.
</span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
  systrace_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(__file__))
  html_prefix <span style="color:#f92672">=</span> read_asset(systrace_dir, <span style="color:#e6db74">&#39;prefix.html&#39;</span>)
  html_suffix <span style="color:#f92672">=</span> read_asset(systrace_dir, <span style="color:#e6db74">&#39;suffix.html&#39;</span>)
  trace_viewer_html <span style="color:#f92672">=</span> read_asset(script_dir, <span style="color:#e6db74">&#39;systrace_trace_viewer.html&#39;</span>)

  <span style="color:#75715e"># Open the file in binary mode to prevent python from changing the</span>
  <span style="color:#75715e"># line endings.</span>
  html_file <span style="color:#f92672">=</span> open(html_filename, <span style="color:#e6db74">&#39;wb&#39;</span>)
  html_file<span style="color:#f92672">.</span>write(html_prefix<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;{{SYSTRACE_TRACE_VIEWER_HTML}}&#39;</span>,
                                      trace_viewer_html))

  html_file<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;&lt;!-- BEGIN TRACE --&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
  <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> agents:
    html_file<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;  &lt;script class=&#34;&#39;</span>)
    html_file<span style="color:#f92672">.</span>write(a<span style="color:#f92672">.</span>get_class_name())
    html_file<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;&#34; type=&#34;application/text&#34;&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
    html_file<span style="color:#f92672">.</span>write(a<span style="color:#f92672">.</span>get_trace_data())
    html_file<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;  &lt;/script&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
  html_file<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;&lt;!-- END TRACE --&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)

  html_file<span style="color:#f92672">.</span>write(html_suffix)
  html_file<span style="color:#f92672">.</span>close()
  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">    wrote file://</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(html_filename))
</code></pre></div><p><strong>3.3 util.py文件</strong></p>
<p>util.py从文件名字可知它是一个工具类，里面主要是定义了执行adb命令的方法<code>run_adb_shell</code>和通过这个方法获取设备的sdk版本的方法<code>get_device_sdk_version</code>。</p>
<p><strong>3.3.1 run_adb_shell方法</strong></p>
<p>该方法将传入的shell命令以及设备的序列号构建成<code>adb -s serial shell xxx</code>的形式，然后利用<code>subprocess</code>模块执行命令并获取得到输出的结果。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_adb_shell</span>(shell_args, device_serial):
  <span style="color:#e6db74">&#34;&#34;&#34;Runs &#34;adb shell&#34; with the given arguments.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  Args:
</span><span style="color:#e6db74">    shell_args: array of arguments to pass to adb shell.
</span><span style="color:#e6db74">    device_serial: if not empty, will add the appropriate command-line
</span><span style="color:#e6db74">        parameters so that adb targets the given device.
</span><span style="color:#e6db74">  Returns:
</span><span style="color:#e6db74">    A tuple containing the adb output (stdout &amp; stderr) and the return code
</span><span style="color:#e6db74">    from adb.  Will exit if adb fails to start.
</span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
  adb_command <span style="color:#f92672">=</span> construct_adb_shell_command(shell_args, device_serial)

  adb_output <span style="color:#f92672">=</span> []
  adb_return_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">try</span>:
    adb_output <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>check_output(adb_command, stderr<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>STDOUT,
                                         shell<span style="color:#f92672">=</span>False, universal_newlines<span style="color:#f92672">=</span>True)
  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">OSError</span> <span style="color:#66d9ef">as</span> error:
    <span style="color:#75715e"># This usually means that the adb executable was not found in the path.</span>
    <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, (<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">The command &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; failed with the following error:&#39;</span>
                          <span style="color:#f92672">%</span> <span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>join(adb_command))
    <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, <span style="color:#e6db74">&#39;    </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> str(error)
    <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, <span style="color:#e6db74">&#39;Is adb in your path?&#39;</span>
    adb_return_code <span style="color:#f92672">=</span> error<span style="color:#f92672">.</span>errno
    adb_output <span style="color:#f92672">=</span> error
  <span style="color:#66d9ef">except</span> subprocess<span style="color:#f92672">.</span>CalledProcessError <span style="color:#66d9ef">as</span> error:
    <span style="color:#75715e"># The process exited with an error.</span>
    adb_return_code <span style="color:#f92672">=</span> error<span style="color:#f92672">.</span>returncode
    adb_output <span style="color:#f92672">=</span> error<span style="color:#f92672">.</span>output

  <span style="color:#66d9ef">return</span> (adb_output, adb_return_code)
</code></pre></div><p><strong>3.3.2 get_device_sdk_version方法</strong></p>
<p>该方法用来获取设备的sdk版本号，它先是利用OptionParser来解析出命令行中的设备序列号，然后调用run_adb_shell方法通过命令来获取sdk版本号。这个方法在<code>atrace_agent</code>的<code>try_create_agent</code>方法中被调用，因为对于不同版本号的Android系统其systrace命令的参数形式略有不同，导致处理方式也略有不同。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_device_sdk_version</span>():
  <span style="color:#e6db74">&#34;&#34;&#34;Uses adb to attempt to determine the SDK version of a running device.&#34;&#34;&#34;</span>

  getprop_args <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;getprop&#39;</span>, <span style="color:#e6db74">&#39;ro.build.version.sdk&#39;</span>]

  <span style="color:#75715e"># get_device_sdk_version() is called before we even parse our command-line</span>
  <span style="color:#75715e"># args.  Therefore, parse just the device serial number part of the</span>
  <span style="color:#75715e"># command-line so we can send the adb command to the correct device.</span>
  parser <span style="color:#f92672">=</span> OptionParserIgnoreErrors()
  parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-e&#39;</span>, <span style="color:#e6db74">&#39;--serial&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;device_serial&#39;</span>, type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;string&#39;</span>)
  options, unused_args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args() <span style="color:#75715e"># pylint: disable=unused-variable</span>

  success <span style="color:#f92672">=</span> False

  adb_output, adb_return_code <span style="color:#f92672">=</span> run_adb_shell(getprop_args,
                                              options<span style="color:#f92672">.</span>device_serial)

  <span style="color:#66d9ef">if</span> adb_return_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
    <span style="color:#75715e"># ADB may print output other than the version number (e.g. it chould</span>
    <span style="color:#75715e"># print a message about starting the ADB server).</span>
    <span style="color:#75715e"># Break the ADB output into white-space delimited segments.</span>
    parsed_output <span style="color:#f92672">=</span> str<span style="color:#f92672">.</span>split(adb_output)
    <span style="color:#66d9ef">if</span> parsed_output:
      <span style="color:#75715e"># Assume that the version number is the last thing printed by ADB.</span>
      version_string <span style="color:#f92672">=</span> parsed_output[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
      <span style="color:#66d9ef">if</span> version_string:
        <span style="color:#66d9ef">try</span>:
          <span style="color:#75715e"># Try to convert the text into an integer.</span>
          version <span style="color:#f92672">=</span> int(version_string)
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span>:
          version <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">else</span>:
          success <span style="color:#f92672">=</span> True

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> success:
    <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, (
        <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">The command &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; failed with the following message:&#39;</span>
        <span style="color:#f92672">%</span> <span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>join(getprop_args))
    <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, adb_output
    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)

  <span style="color:#66d9ef">return</span> version
</code></pre></div><p><strong>3.4 systrace_agent.py文件</strong></p>
<p>systrace_agent.py文件中定义了<code>SystraceAgent</code>类，其中定义了agent的各个抽象方法，例如启动agent的<code>start</code>方法、收集systrace数据的<code>collect_result</code>方法以及获取systrace数据的<code>get_trace_data</code>方法等。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SystraceAgent</span>(object):
  <span style="color:#e6db74">&#34;&#34;&#34;The base class for systrace agents.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  A systrace agent contains the command-line options and trace categories to
</span><span style="color:#e6db74">  capture. Each systrace agent has its own tracing implementation.
</span><span style="color:#e6db74">  &#34;&#34;&#34;</span>

  <span style="color:#66d9ef">def</span> __init__(self, options, categories):
    <span style="color:#e6db74">&#34;&#34;&#34;Initialize a systrace agent.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">      options: The command-line options.
</span><span style="color:#e6db74">categories: &#34;The&#34;
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    self<span style="color:#f92672">.</span>_options <span style="color:#f92672">=</span> options
    self<span style="color:#f92672">.</span>_categories <span style="color:#f92672">=</span> categories

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(self):
    <span style="color:#e6db74">&#34;&#34;&#34;Start tracing.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">collect_result</span>(self):
    <span style="color:#e6db74">&#34;&#34;&#34;Collect the result of tracing.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    This function will block while collecting the result. For sync mode, it
</span><span style="color:#e6db74">    reads the data, e.g., from stdout, until it finishes. For async mode, it
</span><span style="color:#e6db74">    blocks until the agent is stopped and the data is ready.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expect_trace</span>(self):
    <span style="color:#e6db74">&#34;&#34;&#34;Check if the agent is returning a trace or not.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    This will be determined in collect_result().
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">      Whether the agent is expecting a trace or not.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_trace_data</span>(self):
    <span style="color:#e6db74">&#34;&#34;&#34;Get the trace data.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">      The trace data.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_class_name</span>(self):
    <span style="color:#e6db74">&#34;&#34;&#34;Get the class name
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    The class name is used to identify the trace type when the trace is written
</span><span style="color:#e6db74">    to the html file
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">      The class name.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()
</code></pre></div><p><strong>3.5 atrace_agent.py文件</strong></p>
<p><strong>3.5.1 三个Agent类和一些Category</strong></p>
<p>该文件定义了三个agent类，首先是<code>AtraceAgent</code>类，继承自<code>SystraceAgent</code>，是一个核心agent；然后是<code>AtraceLegacyAgent</code>，继承自<code>AtraceAgent</code>，主要是为了兼容Android 4.1及以下版本的系统；最后是<code>BootAgent</code>，继承自<code>AtraceAgent</code>，主要是为了实现在系统启动时的systrace数据抓取。</p>
<p>在命令执行的时候具体创建哪个agent是由方法<code>try_create_agent</code>方法来决定的，该方法会先获取设备的sdk版本。如果版本号大于等于18(Android 4.3及以上版本)，再看参数中是否包含了<code>--boot</code>选项，如果包含了的话就创建BootAgent，如果没有包含的话就创建AtraceAgent；如果版本号大于等于16且小于18(Android 4.1和Android 4.2版本)，就创建AtraceLegacyAgent。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">try_create_agent</span>(options, categories):
  <span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>target <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;android&#39;</span>:
    <span style="color:#66d9ef">return</span> False
  <span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>from_file <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
    <span style="color:#66d9ef">return</span> AtraceAgent(options, categories)

  device_sdk_version <span style="color:#f92672">=</span> util<span style="color:#f92672">.</span>get_device_sdk_version()
  <span style="color:#66d9ef">if</span> device_sdk_version <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">18</span>:
    <span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>boot:
      <span style="color:#75715e"># atrace --async_stop, which is used by BootAgent, does not work properly</span>
      <span style="color:#75715e"># on the device SDK version 22 or before.</span>
      <span style="color:#66d9ef">if</span> device_sdk_version <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">22</span>:
        <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, (<span style="color:#e6db74">&#39;--boot option does not work on the device SDK &#39;</span>
                              <span style="color:#e6db74">&#39;version 22 or before.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Your device SDK version &#39;</span>
                              <span style="color:#e6db74">&#39;is </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">.&#39;</span> <span style="color:#f92672">%</span> device_sdk_version)
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
      <span style="color:#66d9ef">return</span> BootAgent(options, categories)
    <span style="color:#66d9ef">else</span>:
      <span style="color:#66d9ef">return</span> AtraceAgent(options, categories)
  <span style="color:#66d9ef">elif</span> device_sdk_version <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">16</span>:
    <span style="color:#66d9ef">return</span> AtraceLegacyAgent(options, categories)
</code></pre></div><p>systrace抓取的时候一般会指定category，或者叫tag，这些tag是采用位的形式来定义的，和Android系统中的<code>system/core/include/cutils/trace.h</code>文件中的tag一一对应(<strong>源码注释中的文件是错误的</strong>)。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">LEGACY_TRACE_TAG_BITS <span style="color:#f92672">=</span> (
  (<span style="color:#e6db74">&#39;gfx&#39;</span>,       <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">1</span>),
  (<span style="color:#e6db74">&#39;input&#39;</span>,     <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">2</span>),
  (<span style="color:#e6db74">&#39;view&#39;</span>,      <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">3</span>),
  (<span style="color:#e6db74">&#39;webview&#39;</span>,   <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">4</span>),
  (<span style="color:#e6db74">&#39;wm&#39;</span>,        <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">5</span>),
  (<span style="color:#e6db74">&#39;am&#39;</span>,        <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span>),
  (<span style="color:#e6db74">&#39;sm&#39;</span>,        <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">7</span>),
  (<span style="color:#e6db74">&#39;audio&#39;</span>,     <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">8</span>),
  (<span style="color:#e6db74">&#39;video&#39;</span>,     <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">9</span>),
  (<span style="color:#e6db74">&#39;camera&#39;</span>,    <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">10</span>),
)
</code></pre></div><p><strong>3.5.2 FileReaderThread类</strong></p>
<p>该文件还定义了<code>FileReaderThread</code>类，继承自<code>threading.Thread</code>，用于在工作线程上不断地从文件或者管道中读取数据。<code>file_object</code>是对应的文件或者管道对象，<code>output_queue</code>是用来接收读取数据的队列，<code>text_file</code>是用来标示文件是否是文本文件，<code>chunk_size</code>是用来指定每次读取的数据的大小。如果text_file是True的话，说明是文本文件，那么chunk_size参数会被忽略，因为文本文件会一行一行地读取并处理。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileReaderThread</span>(threading<span style="color:#f92672">.</span>Thread):
  <span style="color:#e6db74">&#34;&#34;&#34;Reads data from a file/pipe on a worker thread.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  Use the standard threading. Thread object API to start and interact with the
</span><span style="color:#e6db74">  thread (start(), join(), etc.).
</span><span style="color:#e6db74">  &#34;&#34;&#34;</span>

  <span style="color:#66d9ef">def</span> __init__(self, file_object, output_queue, text_file, chunk_size<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Initializes a FileReaderThread.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">      file_object: The file or pipe to read from.
</span><span style="color:#e6db74">      output_queue: A Queue.Queue object that will receive the data
</span><span style="color:#e6db74">      text_file: If True, the file will be read one line at a time, and
</span><span style="color:#e6db74">          chunk_size will be ignored.  If False, line breaks are ignored and
</span><span style="color:#e6db74">          chunk_size must be set to a positive integer.
</span><span style="color:#e6db74">      chunk_size: When processing a non-text file (text_file = False),
</span><span style="color:#e6db74">          chunk_size is the amount of data to copy into the queue with each
</span><span style="color:#e6db74">          read operation.  For text files, this parameter is ignored.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    threading<span style="color:#f92672">.</span>Thread<span style="color:#f92672">.</span>__init__(self)
    self<span style="color:#f92672">.</span>_file_object <span style="color:#f92672">=</span> file_object
    self<span style="color:#f92672">.</span>_output_queue <span style="color:#f92672">=</span> output_queue
    self<span style="color:#f92672">.</span>_text_file <span style="color:#f92672">=</span> text_file
    self<span style="color:#f92672">.</span>_chunk_size <span style="color:#f92672">=</span> chunk_size
    <span style="color:#66d9ef">assert</span> text_file <span style="color:#f92672">or</span> chunk_size <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self):
    <span style="color:#e6db74">&#34;&#34;&#34;Overrides Thread&#39;s run() function.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns when an EOF is encountered.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_text_file:
      <span style="color:#75715e"># Read a text file one line at a time.</span>
      <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_file_object:
        self<span style="color:#f92672">.</span>_output_queue<span style="color:#f92672">.</span>put(line)
    <span style="color:#66d9ef">else</span>:
      <span style="color:#75715e"># Read binary or text data until we get to EOF.</span>
      <span style="color:#66d9ef">while</span> True:
        chunk <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_file_object<span style="color:#f92672">.</span>read(self<span style="color:#f92672">.</span>_chunk_size)
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> chunk:
          <span style="color:#66d9ef">break</span>
        self<span style="color:#f92672">.</span>_output_queue<span style="color:#f92672">.</span>put(chunk)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_chunk_size</span>(self, chunk_size):
    <span style="color:#e6db74">&#34;&#34;&#34;Change the read chunk size.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    This function can only be called if the FileReaderThread object was
</span><span style="color:#e6db74">    created with an initial chunk_size &gt; 0.
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">      chunk_size: the new chunk size for this file.  Must be &gt; 0.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#75715e"># The chunk size can be changed asynchronously while a file is being read</span>
    <span style="color:#75715e"># in a worker thread.  However, type of file can not be changed after the</span>
    <span style="color:#75715e"># the FileReaderThread has been created.  These asserts verify that we are</span>
    <span style="color:#75715e"># only changing the chunk size, and not the type of file.</span>
    <span style="color:#66d9ef">assert</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>_text_file
    <span style="color:#66d9ef">assert</span> chunk_size <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
    self<span style="color:#f92672">.</span>_chunk_size <span style="color:#f92672">=</span> chunk_size
</code></pre></div><p><strong>3.5.3 AtraceAgent类</strong></p>
<p>AtraceAgent类的实现主要是在<code>start</code>方法中构建对应的atrace命令，然后利用<code>subprocess</code>模块去执行，最后在<code>collect_result</code>方法中解析systrace结果即可。其中的内部变量<code>_expect_trace</code>是用来指示这个命令是否会创建systrace数据，<code>_adb</code>表示<code>subprocess</code>执行的命令，<code>_trace_data</code>是指systrace的数据，<code>_tracer_args</code>是指systracer的参数。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AtraceAgent</span>(systrace_agent<span style="color:#f92672">.</span>SystraceAgent):
  <span style="color:#66d9ef">def</span> __init__(self, options, categories):
    super(AtraceAgent, self)<span style="color:#f92672">.</span>__init__(options, categories)
    self<span style="color:#f92672">.</span>_expect_trace <span style="color:#f92672">=</span> False
    self<span style="color:#f92672">.</span>_adb <span style="color:#f92672">=</span> None
    self<span style="color:#f92672">.</span>_trace_data <span style="color:#f92672">=</span> None
    self<span style="color:#f92672">.</span>_tracer_args <span style="color:#f92672">=</span> None
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>_categories:
      self<span style="color:#f92672">.</span>_categories <span style="color:#f92672">=</span> get_default_categories(self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>device_serial)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(self):
    self<span style="color:#f92672">.</span>_tracer_args <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_construct_trace_command()

    self<span style="color:#f92672">.</span>_adb <span style="color:#f92672">=</span> do_popen(self<span style="color:#f92672">.</span>_tracer_args)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">collect_result</span>(self):
    trace_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_collect_trace_data()
    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_expect_trace:
      self<span style="color:#f92672">.</span>_trace_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_preprocess_trace_data(trace_data)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expect_trace</span>(self):
    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_expect_trace

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_trace_data</span>(self):
    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_trace_data

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_class_name</span>(self):
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;trace-data&#39;</span>
</code></pre></div><p><strong>3.5.3.1 _construct_trace_command方法</strong></p>
<p><code>_construct_trace_command</code>方法的作用是构建atrace命令，其大致流程是：如果命令行中包含了<code>--list_categories</code>选项的话，那么就执行<code>adb [-e serial] shell atrace --list_categories</code>命令来获取所有的categories；如果命令行中包含了<code>--from_file</code>选项的话，那么就实际执行的是<code>cat {file}</code>命令(这个命令经常用于将一个压缩的systrace数据文件转换成html网页结果文件)；如果不是上面两种特殊情况，那么就正常解析命令行参数构建成atrace命令的参数，如果需要压缩数据的话就加上<code>-z</code>选项，如果设置了时间长度的话加上<code>-t {time}</code>选项，如果设置了buffer_size的话就加上<code>-b {buffer_size}</code>，而且如果设置了<code>sched</code>这个tag的话，需要将buffer_size设置为4096，因为默认情况下buffer_size是2048，而sched开启的话需要抓取的数据量会很大，所以设置成默认值的2倍。这部分命令行参数解析完了之后会调用<code>_construct_extra_trace_command</code>方法继续解析<code>-a</code>指定应用以及<code>-k</code>指定内核函数这两个参数。最后调用util.py中的<code>construct_adb_shell_command</code>方法将其封装成一个adb shell命令。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_construct_trace_command</span>(self):
<span style="color:#e6db74">&#34;&#34;&#34;Builds a command-line used to invoke a trace process.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Returns:
</span><span style="color:#e6db74"> A tuple where the first element is an array of command-line arguments, and
</span><span style="color:#e6db74"> the second element is a boolean which will be true if the commend will
</span><span style="color:#e6db74"> stream trace data.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>list_categories:
 tracer_args <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_construct_list_categories_command()
 self<span style="color:#f92672">.</span>_expect_trace <span style="color:#f92672">=</span> False
<span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>from_file <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
 tracer_args <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;cat&#39;</span>, self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>from_file]
 self<span style="color:#f92672">.</span>_expect_trace <span style="color:#f92672">=</span> True
<span style="color:#66d9ef">else</span>:
 atrace_args <span style="color:#f92672">=</span> ATRACE_BASE_ARGS[:]
 self<span style="color:#f92672">.</span>_expect_trace <span style="color:#f92672">=</span> True
 <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>compress_trace_data:
   atrace_args<span style="color:#f92672">.</span>extend([<span style="color:#e6db74">&#39;-z&#39;</span>])

 <span style="color:#66d9ef">if</span> ((self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>trace_time <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None)
     <span style="color:#f92672">and</span> (self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>trace_time <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)):
   atrace_args<span style="color:#f92672">.</span>extend([<span style="color:#e6db74">&#39;-t&#39;</span>, str(self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>trace_time)])

 <span style="color:#66d9ef">if</span> ((self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>trace_buf_size <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None)
     <span style="color:#f92672">and</span> (self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>trace_buf_size <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)):
   atrace_args<span style="color:#f92672">.</span>extend([<span style="color:#e6db74">&#39;-b&#39;</span>, str(self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>trace_buf_size)])
 <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">&#39;sched&#39;</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_categories:
   <span style="color:#75715e"># &#39;sched&#39; is a high-volume tag, double the default buffer size</span>
   <span style="color:#75715e"># to accommodate that</span>
   atrace_args<span style="color:#f92672">.</span>extend([<span style="color:#e6db74">&#39;-b&#39;</span>, <span style="color:#e6db74">&#39;4096&#39;</span>])
 extra_args <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_construct_extra_trace_command()
 atrace_args<span style="color:#f92672">.</span>extend(extra_args)

 tracer_args <span style="color:#f92672">=</span> util<span style="color:#f92672">.</span>construct_adb_shell_command(
     atrace_args, self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>device_serial)

<span style="color:#66d9ef">return</span> tracer_args
</code></pre></div><p><strong>3.5.3.2 _collect_trace_data方法</strong></p>
<p>_collect_trace_data方法的作用是收集trace数据，它先会创建两个队列，一个是标准输出队列，另一个是错误输出队列，然后创建两个对应的工作线程FileReaderThread，它们分别监听标准输出流和错误输出流，前者不是文本数据类型，而后者是文本数据类型。方法中记录的时间的作用其实是为了在<code>status_update</code>方法中检测距离上一次更新时间的时间段，如果超过了<code>MIN_TIME_BETWEEN_STATUS_UPDATES</code>的话就输出一个<code>.</code>以便让使用者知道程序还在执行，而不是挂了。方法中后半部分内容就是在循环读取流中的数据，将其放入到队列中，直到没有任何数据了就关闭流，结束命令返回结果。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_collect_trace_data</span>(self):
  <span style="color:#75715e"># Read the output from ADB in a worker thread.  This allows us to monitor</span>
  <span style="color:#75715e"># the progress of ADB and bail if ADB becomes unresponsive for any reason.</span>

  <span style="color:#75715e"># Limit the stdout_queue to 128 entries because we will initially be reading</span>
  <span style="color:#75715e"># one byte at a time.  When the queue fills up, the reader thread will</span>
  <span style="color:#75715e"># block until there is room in the queue.  Once we start downloading the</span>
  <span style="color:#75715e"># trace data, we will switch to reading data in larger chunks, and 128</span>
  <span style="color:#75715e"># entries should be plenty for that purpose.</span>
  stdout_queue <span style="color:#f92672">=</span> Queue<span style="color:#f92672">.</span>Queue(maxsize<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>)
  stderr_queue <span style="color:#f92672">=</span> Queue<span style="color:#f92672">.</span>Queue()

  <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_expect_trace:
    <span style="color:#75715e"># Use stdout.write() (here and for the rest of this function) instead</span>
    <span style="color:#75715e"># of print() to avoid extra newlines.</span>
    sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;Capturing trace...&#39;</span>)

  <span style="color:#75715e"># Use a chunk_size of 1 for stdout so we can display the output to</span>
  <span style="color:#75715e"># the user without waiting for a full line to be sent.</span>
  stdout_thread <span style="color:#f92672">=</span> FileReaderThread(self<span style="color:#f92672">.</span>_adb<span style="color:#f92672">.</span>stdout, stdout_queue,
                                   text_file<span style="color:#f92672">=</span>False, chunk_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
  stderr_thread <span style="color:#f92672">=</span> FileReaderThread(self<span style="color:#f92672">.</span>_adb<span style="color:#f92672">.</span>stderr, stderr_queue,
                                   text_file<span style="color:#f92672">=</span>True)
  stdout_thread<span style="color:#f92672">.</span>start()
  stderr_thread<span style="color:#f92672">.</span>start()

  <span style="color:#75715e"># Holds the trace data returned by ADB.</span>
  trace_data <span style="color:#f92672">=</span> []
  <span style="color:#75715e"># Keep track of the current line so we can find the TRACE_START_REGEXP.</span>
  current_line <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
  <span style="color:#75715e"># Set to True once we&#39;ve received the TRACE_START_REGEXP.</span>
  reading_trace_data <span style="color:#f92672">=</span> False

  last_status_update_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()

  <span style="color:#66d9ef">while</span> (stdout_thread<span style="color:#f92672">.</span>isAlive() <span style="color:#f92672">or</span> stderr_thread<span style="color:#f92672">.</span>isAlive() <span style="color:#f92672">or</span>
         <span style="color:#f92672">not</span> stdout_queue<span style="color:#f92672">.</span>empty() <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> stderr_queue<span style="color:#f92672">.</span>empty()):
    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_expect_trace:
      last_status_update_time <span style="color:#f92672">=</span> status_update(last_status_update_time)

    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> stderr_queue<span style="color:#f92672">.</span>empty():
      <span style="color:#75715e"># Pass along errors from adb.</span>
      line <span style="color:#f92672">=</span> stderr_queue<span style="color:#f92672">.</span>get()
      sys<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>write(line)

    <span style="color:#75715e"># Read stdout from adb.  The loop exits if we don&#39;t get any data for</span>
    <span style="color:#75715e"># ADB_STDOUT_READ_TIMEOUT seconds.</span>
    <span style="color:#66d9ef">while</span> True:
      <span style="color:#66d9ef">try</span>:
        chunk <span style="color:#f92672">=</span> stdout_queue<span style="color:#f92672">.</span>get(True, ADB_STDOUT_READ_TIMEOUT)
      <span style="color:#66d9ef">except</span> Queue<span style="color:#f92672">.</span>Empty:
        <span style="color:#75715e"># Didn&#39;t get any data, so exit the loop to check that ADB is still</span>
        <span style="color:#75715e"># alive and print anything sent to stderr.</span>
        <span style="color:#66d9ef">break</span>

      <span style="color:#66d9ef">if</span> reading_trace_data:
        <span style="color:#75715e"># Save, but don&#39;t print, the trace data.</span>
        trace_data<span style="color:#f92672">.</span>append(chunk)
      <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>_expect_trace:
          sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(chunk)
        <span style="color:#66d9ef">else</span>:
          <span style="color:#75715e"># Buffer the output from ADB so we can remove some strings that</span>
          <span style="color:#75715e"># don&#39;t need to be shown to the user.</span>
          current_line <span style="color:#f92672">+=</span> chunk
          <span style="color:#66d9ef">if</span> re<span style="color:#f92672">.</span>match(TRACE_START_REGEXP, current_line):
            <span style="color:#75715e"># We are done capturing the trace.</span>
            sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;Done.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
            <span style="color:#75715e"># Now we start downloading the trace data.</span>
            sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;Downloading trace...&#39;</span>)

            current_line <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
            <span style="color:#75715e"># Use a larger chunk size for efficiency since we no longer</span>
            <span style="color:#75715e"># need to worry about parsing the stream.</span>
            stdout_thread<span style="color:#f92672">.</span>set_chunk_size(<span style="color:#ae81ff">4096</span>)
            reading_trace_data <span style="color:#f92672">=</span> True
          <span style="color:#66d9ef">elif</span> chunk <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">or</span> chunk <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span>:
            <span style="color:#75715e"># Remove ADB output that we don&#39;t care about.</span>
            current_line <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>sub(ADB_IGNORE_REGEXP, <span style="color:#e6db74">&#39;&#39;</span>, current_line)
            <span style="color:#66d9ef">if</span> len(current_line) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
              <span style="color:#75715e"># ADB printed something that we didn&#39;t understand, so show it</span>
              <span style="color:#75715e"># it to the user (might be helpful for debugging).</span>
              sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(current_line)
            <span style="color:#75715e"># Reset our current line.</span>
            current_line <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>

  <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_expect_trace:
    <span style="color:#66d9ef">if</span> reading_trace_data:
      <span style="color:#75715e"># Indicate to the user that the data download is complete.</span>
      sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;Done.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
    <span style="color:#66d9ef">else</span>:
      <span style="color:#75715e"># We didn&#39;t receive the trace start tag, so something went wrong.</span>
      sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;ERROR.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
      <span style="color:#75715e"># Show any buffered ADB output to the user.</span>
      current_line <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>sub(ADB_IGNORE_REGEXP, <span style="color:#e6db74">&#39;&#39;</span>, current_line)
      <span style="color:#66d9ef">if</span> current_line:
        sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(current_line)
        sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)

  <span style="color:#75715e"># The threads should already have stopped, so this is just for cleanup.</span>
  stdout_thread<span style="color:#f92672">.</span>join()
  stderr_thread<span style="color:#f92672">.</span>join()

  self<span style="color:#f92672">.</span>_adb<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>close()
  self<span style="color:#f92672">.</span>_adb<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>close()

  <span style="color:#75715e"># The adb process should be done since it&#39;s io pipes are closed.  Call</span>
  <span style="color:#75715e"># poll() to set the return code.</span>
  self<span style="color:#f92672">.</span>_adb<span style="color:#f92672">.</span>poll()

  <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_adb<span style="color:#f92672">.</span>returncode <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
    <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, (<span style="color:#e6db74">&#39;The command &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; returned error code </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">.&#39;</span> <span style="color:#f92672">%</span>
                          (<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>_tracer_args), self<span style="color:#f92672">.</span>_adb<span style="color:#f92672">.</span>returncode))
    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)

  <span style="color:#66d9ef">return</span> trace_data
</code></pre></div><p><strong>3.5.3.3 _preprocess_trace_data方法</strong></p>
<p>_preprocess_trace_data方法是用来预处理trace数据的，atrace_agent.py文件中定义了很多<code>fix_xxx</code>的方法，用于修复trace数据中的部分数据，例如<code>fix_thread_names</code>用来修复线程名字，修复的方法是调用<code>ps -t</code>命令来获取当前系统中的线程的id及其对应的名称，其他的fix方法与之类似。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_preprocess_trace_data</span>(self, trace_data):
    <span style="color:#e6db74">&#34;&#34;&#34;Performs various processing on atrace data.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">      trace_data: The raw trace data.
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">      The processed trace data.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    trace_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(trace_data)
    <span style="color:#66d9ef">if</span> trace_data:
      trace_data <span style="color:#f92672">=</span> strip_and_decompress_trace(trace_data)

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> trace_data:
      <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, (<span style="color:#e6db74">&#39;No data was captured.  Output file was not &#39;</span>
                            <span style="color:#e6db74">&#39;written.&#39;</span>)
      sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)

    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>fix_threads:
      <span style="color:#75715e"># Issue ps command to device and patch thread names</span>
      ps_dump <span style="color:#f92672">=</span> do_preprocess_adb_cmd(<span style="color:#e6db74">&#39;ps -t&#39;</span>, self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>device_serial)
      <span style="color:#66d9ef">if</span> ps_dump <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
        thread_names <span style="color:#f92672">=</span> extract_thread_list(ps_dump)
        trace_data <span style="color:#f92672">=</span> fix_thread_names(trace_data, thread_names)

    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>fix_tgids:
      <span style="color:#75715e"># Issue printf command to device and patch tgids</span>
      procfs_dump <span style="color:#f92672">=</span> do_preprocess_adb_cmd(<span style="color:#e6db74">&#39;printf &#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34; &#39;</span> <span style="color:#f92672">+</span>
                                          <span style="color:#e6db74">&#39;/proc/[0-9]*/task/[0-9]*&#39;</span>,
                                          self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>device_serial)
      <span style="color:#66d9ef">if</span> procfs_dump <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
        pid2_tgid <span style="color:#f92672">=</span> extract_tgids(procfs_dump)
        trace_data <span style="color:#f92672">=</span> fix_missing_tgids(trace_data, pid2_tgid)

    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>fix_circular:
      trace_data <span style="color:#f92672">=</span> fix_circular_traces(trace_data)

    <span style="color:#66d9ef">return</span> trace_data
</code></pre></div><p><strong>3.5.4 AtraceLegacyAgent类</strong></p>
<p>AtraceLegacyAgent继承自AtraceAgent，区别在于它适用于Android 4.1及以下系统，实现方式是重写了AtraceAgent中的_construct_list_categories_command和_construct_extra_trace_command方法，因为它们的命令行的参数选项略有不同。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AtraceLegacyAgent</span>(AtraceAgent):
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_construct_list_categories_command</span>(self):
    LEGACY_CATEGORIES <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;       sched - CPU Scheduling
</span><span style="color:#e6db74">        freq - CPU Frequency
</span><span style="color:#e6db74">        idle - CPU Idle
</span><span style="color:#e6db74">        load - CPU Load
</span><span style="color:#e6db74">        disk - Disk I/O (requires root)
</span><span style="color:#e6db74">         bus - Bus utilization (requires root)
</span><span style="color:#e6db74">   workqueue - Kernel workqueues (requires root)&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">&#34;echo&#34;</span>, LEGACY_CATEGORIES]

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(self):
    super(AtraceLegacyAgent, self)<span style="color:#f92672">.</span>start()
    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>expect_trace():
      SHELL_ARGS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;getprop&#39;</span>, <span style="color:#e6db74">&#39;debug.atrace.tags.enableflags&#39;</span>]
      output, return_code <span style="color:#f92672">=</span> util<span style="color:#f92672">.</span>run_adb_shell(SHELL_ARGS,
                                               self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>device_serial)
      <span style="color:#66d9ef">if</span> return_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, (
            <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">The command &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; failed with the following message:&#39;</span>
            <span style="color:#f92672">%</span> <span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>join(SHELL_ARGS))
        <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, str(output)
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)

      flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
      <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">if</span> output<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;0x&#39;</span>):
          flags <span style="color:#f92672">=</span> int(output, <span style="color:#ae81ff">16</span>)
        <span style="color:#66d9ef">elif</span> output<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;0&#39;</span>):
          flags <span style="color:#f92672">=</span> int(output, <span style="color:#ae81ff">8</span>)
        <span style="color:#66d9ef">else</span>:
          flags <span style="color:#f92672">=</span> int(output)
      <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span>:
        <span style="color:#66d9ef">pass</span>

      <span style="color:#66d9ef">if</span> flags:
        tags <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> desc, bit <span style="color:#f92672">in</span> LEGACY_TRACE_TAG_BITS:
          <span style="color:#66d9ef">if</span> bit <span style="color:#f92672">&amp;</span> flags:
            tags<span style="color:#f92672">.</span>append(desc)
        categories <span style="color:#f92672">=</span> tags <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>_categories
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Collecting data with following categories:&#39;</span>, <span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>join(categories)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_construct_extra_trace_command</span>(self):
    extra_args <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>_categories:
      self<span style="color:#f92672">.</span>_categories <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;sched&#39;</span>, ]
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;sched&#39;</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_categories:
      extra_args<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;-s&#39;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;freq&#39;</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_categories:
      extra_args<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;-f&#39;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;idle&#39;</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_categories:
      extra_args<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;-i&#39;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;load&#39;</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_categories:
      extra_args<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;-l&#39;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;disk&#39;</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_categories:
      extra_args<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;-d&#39;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;bus&#39;</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_categories:
      extra_args<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;-u&#39;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;workqueue&#39;</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_categories:
      extra_args<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;-w&#39;</span>)

    <span style="color:#66d9ef">return</span> extra_args
</code></pre></div><p><strong>3.5.5 BootAgent类</strong></p>
<p>BootAgent同样继承自AtraceAgent，但是它适用于在设备启动的时候抓取systrace数据。它需要将指定的categories写入到<code>/data/misc/boottrace/categories</code>文件中，然后将<code>persist.debug.atrace.boottrace</code>属性置为1，最后执行重启<code>reboot</code>即可。待系统启动之后，利用Ctrl+C来结束抓取，此时会执行<code>atrace --async_stop</code>命令结束。在设备启动时抓取systrace数据的需求较少，所以<code>--boot</code>这个选项很少使用。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BootAgent</span>(AtraceAgent):
  <span style="color:#e6db74">&#34;&#34;&#34;AtraceAgent that specializes in tracing the boot sequence.&#34;&#34;&#34;</span>

  <span style="color:#66d9ef">def</span> __init__(self, options, categories):
    super(BootAgent, self)<span style="color:#f92672">.</span>__init__(options, categories)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(self):
    <span style="color:#66d9ef">try</span>:
      setup_args <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_construct_setup_command()
      <span style="color:#66d9ef">try</span>:
        subprocess<span style="color:#f92672">.</span>check_call(setup_args)
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Hit Ctrl+C once the device has booted up.&#39;</span>
        <span style="color:#66d9ef">while</span> True:
          time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
      <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
        <span style="color:#66d9ef">pass</span>
      tracer_args <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_construct_trace_command()
      self<span style="color:#f92672">.</span>_adb <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>Popen(tracer_args, stdout<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE,
                                   stderr<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE)
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">OSError</span> <span style="color:#66d9ef">as</span> error:
      <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, (
          <span style="color:#e6db74">&#39;The command &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; failed with the following error:&#39;</span> <span style="color:#f92672">%</span>
          <span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>join(tracer_args))
      <span style="color:#66d9ef">print</span> <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, <span style="color:#e6db74">&#39;    &#39;</span>, error
      sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_construct_setup_command</span>(self):
    echo_args <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;echo&#39;</span>] <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>_categories <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#39;&gt;&#39;</span>, BOOTTRACE_CATEGORIES]
    setprop_args <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;setprop&#39;</span>, BOOTTRACE_PROP, <span style="color:#e6db74">&#39;1&#39;</span>]
    reboot_args <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;reboot&#39;</span>]
    <span style="color:#66d9ef">return</span> util<span style="color:#f92672">.</span>construct_adb_shell_command(
        echo_args <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#39;&amp;&amp;&#39;</span>] <span style="color:#f92672">+</span> setprop_args <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#39;&amp;&amp;&#39;</span>] <span style="color:#f92672">+</span> reboot_args,
        self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>device_serial)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_construct_trace_command</span>(self):
    self<span style="color:#f92672">.</span>_expect_trace <span style="color:#f92672">=</span> True
    atrace_args <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;atrace&#39;</span>, <span style="color:#e6db74">&#39;--async_stop&#39;</span>]
    setprop_args <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;setprop&#39;</span>, BOOTTRACE_PROP, <span style="color:#e6db74">&#39;0&#39;</span>]
    rm_args <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;rm&#39;</span>, BOOTTRACE_CATEGORIES]
    <span style="color:#66d9ef">return</span> util<span style="color:#f92672">.</span>construct_adb_shell_command(
          atrace_args <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#39;&amp;&amp;&#39;</span>] <span style="color:#f92672">+</span> setprop_args <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#39;&amp;&amp;&#39;</span>] <span style="color:#f92672">+</span> rm_args,
          self<span style="color:#f92672">.</span>_options<span style="color:#f92672">.</span>device_serial)
</code></pre></div><p>OK，本文的systrace工具源码分析结束，后面会抽空陆续加上Android系统中systrace相关的类和文件的源码解析，以及利用systrace数据来分析应用性能问题的方法。</p>
    </section>

    <footer class="post-footer">
      
        <figure class="author-image">
            <a class="img" href="https://hujiaweibujidao.github.io/" style="background-image: url(https://hujiaweibujidao.github.io/images/logo.gif)"><span class="hidden">hujiawei's Picture</span></a>
        </figure>
      

      





<section class="author" style="width:100%;">
  <div class="author-meta" style="width:100%;text-align:center;">
    <span class="author-location icon-user"> Hujiawei is a mobile developer</span>
    <span class="author-location icon-location"> Guangdong, China</span>
    <span class="author-link icon-link"><a href="https://hujiaweibujidao.github.io/"> https://hujiaweibujidao.github.io/</a></span>
    

    
  </div>
  <br/>
</section>


      
        <aside class="read-next">
  
      <span class="readmore-prev readmore-meta">PREV: <a href="https://hujiaweibujidao.github.io/blog/2016/10/03/build-android-source-code-on-mac/"><h4>Build Android Source Code on Mac</h4></a></span>
      
  

  
      <span class="readmore-next readmore-meta">NEXT: <a href="https://hujiaweibujidao.github.io/blog/2016/06/25/ways-to-use-icons-on-android-2/"><h4>Ways to Use Icons on Android (2)</h4></a></span>
      
  
</aside>
<br/>

      
      
      
    </footer>
</article>

</main>

    <footer class="site-footer clearfix">
        <a id="gotop" class="icon-arrow-up" href="#" title="back to top"></a>

        <section class="copyright"><a href="">Hujiawei Bujidao. </a> All rights reserved &copy; 2013 - 2020</section>
        
        <section class="poweredby">Proudly generated by <a href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme &nbsp;
            
            <script type="text/javascript">
                var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
                document.write(unescape("%3Cspan id='cnzz_stat_icon_1000165127'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1000165127%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
            </script>
        </section>
        
    </footer>
  </div> 
    <script type="text/javascript" src="https://hujiaweibujidao.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="https://hujiaweibujidao.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://hujiaweibujidao.github.io/js/index.js"></script>

    
    
    
    

    
</body>
</html>

